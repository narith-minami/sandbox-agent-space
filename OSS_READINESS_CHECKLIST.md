# OSS公開に向けた改善チェックリスト

本ドキュメントは、sandbox-agent-space をOSSとして公開するために必要な改善点をまとめたものです。

---

## 1. ライセンス・法的整備

| # | 項目 | 優先度 | 状態 | 詳細 |
|---|------|--------|------|------|
| 1.1 | LICENSE ファイルの追加 | 🔴 必須 | ❌ 未対応 | README に MIT と記載があるが、実際の LICENSE ファイルが存在しない。リポジトリルートに追加すること |
| 1.2 | 各ファイルのライセンスヘッダー | 🟡 推奨 | ❌ 未対応 | 主要ソースファイルにライセンスヘッダーの追加を検討 |
| 1.3 | 依存ライブラリのライセンス互換性確認 | 🔴 必須 | ❌ 未対応 | 全依存パッケージのライセンスが MIT と互換性があるか確認する |

## 2. コミュニティ・ガバナンス文書

| # | 項目 | 優先度 | 状態 | 詳細 |
|---|------|--------|------|------|
| 2.1 | CONTRIBUTING.md | 🔴 必須 | ❌ 未対応 | 開発環境構築手順、PR の出し方、コーディング規約、コミットメッセージ規約などを記載 |
| 2.2 | CODE_OF_CONDUCT.md | 🟡 推奨 | ❌ 未対応 | Contributor Covenant 等を採用し、コミュニティの行動規範を明示 |
| 2.3 | SECURITY.md | 🔴 必須 | ❌ 未対応 | 脆弱性報告のプロセス・連絡先を明記（responsible disclosure） |
| 2.4 | CHANGELOG.md | 🟡 推奨 | ❌ 未対応 | [Keep a Changelog](https://keepachangelog.com/) 形式でリリース履歴を管理 |
| 2.5 | Issue / PR テンプレート | 🟡 推奨 | ❌ 未対応 | `.github/ISSUE_TEMPLATE/` および `.github/PULL_REQUEST_TEMPLATE.md` を用意 |

## 3. ドキュメント

| # | 項目 | 優先度 | 状態 | 詳細 |
|---|------|--------|------|------|
| 3.1 | .env.example の追加 | 🔴 必須 | ❌ 未対応 | 必要な環境変数の一覧とデフォルト値・説明を記載したサンプルファイル |
| 3.2 | README の英語化 / 多言語対応 | 🟡 推奨 | ⚠️ 一部対応 | README は英語だが、`docs/plan.md` が日本語のみ。グローバル公開なら英語メインを推奨 |
| 3.3 | API ドキュメントの拡充 | 🟡 推奨 | ⚠️ 一部対応 | README に基本記載はあるが、OpenAPI / Swagger 等での正式なAPI仕様書が望ましい |
| 3.4 | アーキテクチャドキュメント | 🟢 任意 | ❌ 未対応 | システム構成図、データフロー図などを追加するとコントリビューターに有用 |
| 3.5 | ローカル開発環境のセットアップガイド | 🔴 必須 | ⚠️ 一部対応 | DB セットアップ、マイグレーション実行手順など具体的な手順を記載 |

## 4. テスト

| # | 項目 | 優先度 | 状態 | 詳細 |
|---|------|--------|------|------|
| 4.1 | テストフレームワークの導入 | 🔴 必須 | ❌ 未対応 | Vitest 等を導入。現在テストファイルがゼロ |
| 4.2 | ユニットテスト | 🔴 必須 | ❌ 未対応 | バリデーション (`lib/validators/`)、ユーティリティ (`lib/utils.ts`)、DB クエリ (`lib/db/queries.ts`) 等 |
| 4.3 | API ルートの統合テスト | 🟡 推奨 | ❌ 未対応 | 各 API エンドポイントのリクエスト/レスポンス検証 |
| 4.4 | E2E テスト | 🟢 任意 | ❌ 未対応 | Playwright 等によるブラウザテスト |
| 4.5 | テストカバレッジの計測と目標設定 | 🟡 推奨 | ❌ 未対応 | 最低限主要ロジックの 80% カバレッジを目標に |

## 5. CI/CD

| # | 項目 | 優先度 | 状態 | 詳細 |
|---|------|--------|------|------|
| 5.1 | GitHub Actions ワークフロー | 🔴 必須 | ❌ 未対応 | lint, type-check, test を PR ごとに自動実行 |
| 5.2 | 依存関係の脆弱性スキャン | 🟡 推奨 | ❌ 未対応 | `npm audit` や Dependabot / Renovate の設定 |
| 5.3 | 自動リリースパイプライン | 🟢 任意 | ❌ 未対応 | semantic-release 等によるバージョニングとリリースノート自動生成 |
| 5.4 | pre-commit フック | 🟡 推奨 | ❌ 未対応 | husky + lint-staged で lint / format をコミット時に強制 |

## 6. セキュリティ

| # | 項目 | 優先度 | 状態 | 詳細 |
|---|------|--------|------|------|
| 6.1 | 認証・認可の強化 | 🔴 必須 | ⚠️ 一部対応 | 現在 Vercel OIDC トークンによる認証のみ。API ルートに対する一貫した認証ミドルウェアが必要 |
| 6.2 | CORS 設定の厳格化 | 🟡 推奨 | ⚠️ 要改善 | `vercel.json` で `Access-Control-Allow-Origin: *` となっており、本番運用では制限が必要 |
| 6.3 | リクエストサイズ制限 | 🟡 推奨 | ❌ 未対応 | POST ボディのサイズ上限が未設定 |
| 6.4 | エラーメッセージの情報漏洩防止 | 🟡 推奨 | ⚠️ 要改善 | 一部のエラーレスポンスが内部実装の詳細を公開している |
| 6.5 | シークレットスキャン | 🟡 推奨 | ❌ 未対応 | git-secrets / gitleaks 等でコミット前にシークレット混入を防止 |
| 6.6 | レート制限のデフォルト値見直し | 🟢 任意 | ⚠️ 要改善 | ハードコードされたデフォルト値 (10 req/min) の設定可能化 |

## 7. コード品質

| # | 項目 | 優先度 | 状態 | 詳細 |
|---|------|--------|------|------|
| 7.1 | 構造化ログの導入 | 🟡 推奨 | ❌ 未対応 | `console.error` のみの利用を Pino / Winston 等に置換し、JSON 形式のログ出力を実現 |
| 7.2 | PR 検出用正規表現の重複修正 | 🟢 任意 | ⚠️ 要修正 | `lib/sandbox/pr-detector.ts` の 11 行目と 17 行目に同一パターンが重複 |
| 7.3 | ヘルスチェックエンドポイント | 🟡 推奨 | ❌ 未対応 | `/api/health` エンドポイントを追加し、DB 接続やサービス状態を確認可能に |
| 7.4 | Prettier の導入 | 🟡 推奨 | ❌ 未対応 | コードフォーマットの統一。ESLint のみでは不十分 |
| 7.5 | エラーハンドリングの共通化 | 🟢 任意 | ⚠️ 一部対応 | 各 API ルートで個別に try-catch しているが、共通ミドルウェアでの一元化が望ましい |

## 8. デプロイ・運用

| # | 項目 | 優先度 | 状態 | 詳細 |
|---|------|--------|------|------|
| 8.1 | 関数タイムアウトの不整合修正 | 🔴 必須 | ⚠️ 要修正 | `vercel.json` の `maxDuration: 300`（5分）とサンドボックスの最大45分が矛盾 |
| 8.2 | Docker / docker-compose 対応 | 🟡 推奨 | ❌ 未対応 | Vercel 以外でもローカル実行・セルフホスト可能にする |
| 8.3 | 環境変数のバリデーション強化 | 🟡 推奨 | ⚠️ 一部対応 | 起動時に必須環境変数の存在チェックとエラーメッセージ表示 |
| 8.4 | モニタリング・メトリクス | 🟢 任意 | ❌ 未対応 | OpenTelemetry 等によるトレーシング・メトリクス収集 |

---

## 優先度の凡例

| 記号 | 意味 | 説明 |
|------|------|------|
| 🔴 必須 | Critical | OSS 公開前に必ず対応すべき |
| 🟡 推奨 | Recommended | 公開後早期に対応が望ましい |
| 🟢 任意 | Nice to have | プロジェクト成熟に合わせて対応 |

## 対応の推奨順序

1. **Phase 1 — 公開前必須**（🔴 全項目）
   - LICENSE ファイル追加
   - .env.example 作成
   - CONTRIBUTING.md / SECURITY.md 作成
   - テストフレームワーク導入と最低限のユニットテスト
   - GitHub Actions による CI パイプライン
   - 認証の一貫性確保
   - vercel.json のタイムアウト不整合修正
   - 依存ライブラリのライセンス確認

2. **Phase 2 — 公開直後**（🟡 主要項目）
   - CODE_OF_CONDUCT.md / CHANGELOG.md
   - CORS 設定厳格化
   - 統合テスト追加
   - Dependabot / Renovate 設定
   - 構造化ログ導入
   - Docker 対応

3. **Phase 3 — 成熟期**（🟢 全項目）
   - E2E テスト
   - OpenAPI ドキュメント
   - 自動リリースパイプライン
   - モニタリング / トレーシング
